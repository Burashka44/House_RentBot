Бот «Аренда + Коммуналка» (Telegram) — Полное описание идеи и устройства
Версия: 1.0 (описание для другой нейросети / разработчика)
Язык интерфейса: русский (комментарии в коде допускаются на английском)

1) Зачем нужен бот (идея продукта)
Бот автоматизирует управление арендой недвижимости (квартиры/объекты) и расчёты с арендаторами:
- фиксированная аренда или аренда + коммунальные начисления
- разные даты оплат по аренде и по коммуналке для каждого объекта
- напоминания до срока оплаты
- сбор платежей (перевод на карту/кошельки) + подтверждение оплаты (чек/скрин)
- учет начислений/оплат по коммуналке, включая интернет/ТВ/телефон (как отдельные услуги)
- двусторонняя связь админ ↔ арендатор (сообщения, фото)
- архив арендаторов после выселения с сохранением истории и привязками
- коммерческая ценность: бота можно продавать владельцам/управляющим как SaaS-решение

Ключевой принцип: арендатор видит только свой объект и только свои платежи/начисления.

2) Роли и доступы
Роли:
A) Владелец (owner)
- создаёт объекты (квартиры/помещения)
- добавляет администраторов/менеджеров
- задаёт реквизиты получения оплаты (карта/ЮMoney и др.)
- задаёт правила оплаты (фикс/фикс+коммуналка, даты платежей, предоплаты)
- видит всю аналитику по всем объектам

B) Администратор/Менеджер (admin/manager)
- управляет объектами (по правам)
- добавляет/удаляет арендаторов, переводит в архив
- видит начисления/оплаты, подтверждает чеки
- переписка с арендаторами, приём фото/сообщений
- может вручную корректировать начисления/платежи
- может запрашивать статус по объекту

C) Арендатор (tenant)
- привязан к одному активному объекту
- видит только свои начисления и историю оплат
- получает напоминания, оплачивает и прикладывает чек
- может отключить/включить напоминания
- может отправлять сообщения/фото администратору
- может удалить сохранённую карту/метод оплаты (если используется сохранение)

D) Система/бот (system)
- планировщик начислений/напоминаний
- агрегатор “сначала собрать начисления, потом напомнить”
- модуль проверки чеков (OCR/валидация) и сопоставления с начислениями

3) Онбординг (как бот понимает, кто арендатор, а кто админ)
Важно: Telegram даёт bot’у Telegram ID, username и т.д. только когда пользователь пишет боту.

3.1. Админская часть (создание объекта и арендатора)
- Админ создаёт объект (квартира): адрес, параметры оплаты (аренда/коммуналка), даты платежей.
- Админ добавляет арендатора в объект:
  - телефон
  - email
  - паспортные данные (как строка/структура)
  - ФИО (ввод вручную, не полагаемся на first_name/last_name TG)
  - дополнительные заметки
  - опционально: “архивировать после выселения” (галочка по умолчанию включена)

- Бот генерирует “приглашение” (invite):
  Вариант 1 (простой): арендатор сам пишет боту /start → админ подтверждает привязку.
  Вариант 2 (надежный): одноразовый код/ссылка:
    - bot выдаёт admin’у invite-код, связанный с tenant-записью и объектом
    - арендатор вводит код в боте
    - бот привязывает Telegram ID и username к tenant-профилю

3.2. Как бот различает роль
- У админов/владельца Telegram ID заранее в таблице users с role=admin/owner.
- У арендатора роль определяется по записи tenant_profile, привязанной к объекту + привязке Telegram ID.
- Если пользователь не найден ни в admins, ни в tenants → гость (предлагаем “введите код приглашения” или “обратитесь к администратору”).

4) Модель данных (что хранится)
4.1. Согласие на обработку персональных данных (обязательно)
При первом входе арендатор должен поставить галочку:
Текст согласия:
«Вы предоставляете и подтверждаете согласие на обработку персональных данных, которые ранее уже предоставили при заключении договора, а также на обработку данных, которые вы отправляете в бот (включая чеки/фото). Данные используются строго для работы сервиса.»

Перечень данных (храним только необходимое):
- ФИО
- паспортные данные
- ваши фотографии (в том числе чеки и вложения)
- номер телефона
- электронную почту
- Telegram ID
- username
- данные об оплатах и начислениях

Без согласия доступ к функционалу арендатора блокируется (только экран согласия).

4.2. Основные сущности
- User (admin/owner/manager): telegram_id, username, role, permissions
- TenantProfile: ФИО, паспорт, phone, email, telegram_id, username, consent_flag, consent_timestamp, архивный/активный
- RentalObject (квартира/объект): адрес, метаданные, владелец, параметры оплаты, даты платежей, валюта
- Occupancy (проживание/договор в системе): object_id + tenant_id + даты (заезд/выезд) + статус active/archived
  (важно для истории: один tenant может жить в разных объектах в разное время)

- PaymentMethod: тип (карта/ЮMoney/др.), реквизиты получателя, “назначение платежа по умолчанию”, правила отображения
  (сохранение карты — только если применяется легальный платежный провайдер; иначе “сохранить карту” = сохранять только маску/метку, без CVV)

- Charge (начисление): тип (rent/utility/internet/tv/phone/other), период, сумма, дата оплаты (due_date), статус (ожидает/оплачено/частично/просрочено)
- Payment (оплата): сумма, дата, тип оплаты (перевод/кошелек), статус (в ожидании/подтверждена/отклонена), ссылки на чек/вложения
- ReceiptAttachment: файл/фото/документ, результат OCR, извлеченные поля, валидность
- Provider (РСО/поставщик услуги): тип, название, регион, сайт/контакты (опционально), правила распознавания
- ObjectProviderLink: привязка поставщиков к объекту (вода/свет/тепло/мусор/интернет и т.п.)

4.3. Архивирование арендатора и история
- По умолчанию при “выселении” tenant не удаляется, а переводится в архив (архивный occupancy).
- Сохранение истории:
  - tenant_profile сохраняется
  - все charges/payments/receipts остаются связаны с соответствующим occupancy (договором проживания)
- Если tenant снова въезжает в тот же объект:
  - можно повторно активировать профайл и создать новый occupancy
  - история доступна админам; арендаторам показываем только текущий/разрешенный период
- Если tenant въезжает в другой объект того же владельца:
  - бот уведомляет админа о долгах/хвостах по прошлому объекту (если есть)

5) Автоопределение УК и РСО по адресу (логика «как Квартплата+»)
Цель: админ вводит адрес объекта → бот предлагает привязанную УК → после подтверждения предлагает набор РСО (поставщиков) для дома.

Способ №1 (основной): локальная база домов
- Таблица houses: регион/город/улица/дом → uk_id
- Таблица uk_companies: УК (название, ИНН, контакты)
- Таблица uk_rso_links: uk_id → provider_id (какие РСО обычно связаны с этой УК)
- Таблица object_rso_links: object_id → provider_id (фактическая привязка услуги/поставщика к объекту)

Процесс:
1) Админ вводит адрес
2) Адрес нормализуется (street, house_number и т.д.)
3) Поиск в houses → если нашли UK → показать карточку УК с кнопками [Привязать]/[Нет]
4) После привязки УК: получить providers через uk_rso_links, спросить [Привязать РСО автоматически?]
5) При согласии — создать object_rso_links (без дублей)

Если дом не найден:
- сообщаем: «УК не найдена в базе, добавьте вручную или обновите базу домов»
- у админа есть команды /uk_add, /house_add, /house_find

6) Начисления и напоминания
6.1. Раздельные даты платежей
- У каждого объекта есть отдельные даты:
  - due_day_rent (например, 5-е число)
  - due_day_utilities (например, 22-е число)
  - optional: due_day_internet, due_day_tv, due_day_phone
- Даты могут быть разными для каждой квартиры и зависят от даты заезда.

6.2. Агрегатор коммуналки: «сначала собрать — потом напомнить»
Требование: арендатор не должен платить 3–8 раз.
Логика:
- В течение расчетного периода бот накапливает начисления по коммунальным услугам
- К моменту due_day_utilities бот проверяет: собраны ли начисления (например, 5 из 7)
- Тогда отправляет одно уведомление “Коммунальные платежи готовы” + список услуг + одна кнопка “Оплатить/подтвердить”

6.3. Напоминания
- За 3 дня до срока: напоминание об аренде
- За 3 дня до срока: напоминание о коммуналке
- Настройки:
  - можно отключить напоминания (tenant-level)
  - можно отключить напоминания по конкретному типу платежа

7) Оплата: способы и подтверждение
7.1. Платежи «перевод на карту / кошелек»
Бот показывает:
- имя получателя
- реквизиты (номер карты/кошелек)
- назначение платежа (по умолчанию или редактируемое)
- сумма к оплате (из начислений)
Арендатор оплачивает вне бота (банком/приложением) и подтверждает чек.

7.2. “Платёжный хаб”
Если внедряется платёжный провайдер (будущее SaaS):
- встроенная оплата внутри Telegram (если доступно) или через ссылку
- тогда возможна “сохранить карту” в рамках токенизации провайдера
Если нет провайдера — “сохранение карты” не хранит CVV/полные данные (только маска/метка/последние 4 цифры, если арендатор ввел).

8) Чеки и распознавание (OCR/валидация)
Цель: арендатор отправляет чек → бот пытается распознать и сопоставить.

8.1. Поток:
1) Арендатор отправляет фото/скрин/файл
2) Бот запускает OCR (опционально)
3) Извлекает поля:
   - сумма
   - дата/время
   - получатель/название банка/назначение
   - при коммуналке: название РСО/поставщика, лицевой счет (если виден)
4) Пытается сопоставить:
   - сумма совпадает с ожидаемым начислением (или в пределах допуска)
   - получатель совпадает с реквизитами, заданными владельцем
   - при коммуналке: совпадает РСО/поставщик, привязанный к объекту

8.2. Негативные ответы (строгие требования):
- «Не удалось сопоставить сумму с начислениями. Проверьте, что вы отправили правильный чек, либо свяжитесь с администратором.»
- «Данное изображение не относится к платежам по вашему договору аренды. Отправьте чек, где указан верный получатель.»
- «Изображение нечитаемо. Отправьте более чёткую фотографию/скриншот.»
- «Не удалось распознать получателя/РСО. Отправьте чек крупнее или обратитесь к администратору.»

8.3. Админ-верификация
Даже при успешном OCR:
- бот отправляет админам уведомление о новой оплате
- админ может подтвердить/отклонить/исправить сумму/привязку
Если OCR не сработал — чек всё равно можно подтвердить вручную.

9) Интернет/ТВ/Телефон: как моделируется
Требование: у провайдера может быть один лицевой счет на интернет+ТВ, либо разные.
Решение:
- Услуга = ServiceType (internet / tv / phone / bundle)
- У объекта можно завести “пакет” (bundle) или отдельные услуги:
  - provider_id (поставщик)
  - account_id (лицевой счет)
  - due_date
  - enabled_flag (арендатор может отключить услугу, если не пользуется)

10) Коммуникации админ ↔ арендатор
10.1. Сообщения арендатора
- арендатор отправляет текст/фото/вложения без “пустых форм”
- бот пересылает/логирует сообщение админу с привязкой к объекту и tenant_id

10.2. Сообщения администратора
- админ выбирает объект/арендатора и отправляет сообщение
- арендатор получает в своем чате с ботом
- все сообщения могут логироваться (опционально) для истории

11) Команды/интерфейс (кратко)
Tenant:
- /start
- Мой объект
- Аренда (начисления, оплатить, прикрепить чек)
- Коммуналка (список начислений, оплатить, прикрепить чек)
- История оплат
- Настройки (напоминания on/off, методы оплаты)
- Поддержка (написать админу + фото)

Admin:
- Объекты (создать/редактировать)
- Арендаторы (добавить/выселить/архив)
- Начисления (создать/импортировать/исправить)
- Оплаты (подтвердить/отклонить)
- РСО (привязка к объекту, управление)
- /uk_add, /house_add, /house_find
- /rso_list, /rso_add, /rso_remove
- Статус объекта (все оплаты/долги)

12) Техническая архитектура (в общих чертах)
- Ядро: aiogram (polling)
- Конфигурация: .env (BOT_TOKEN, DATABASE_URL и т.п.)
- База данных:
  - для dev: SQLite (sqlite+aiosqlite)
  - для prod: PostgreSQL (asyncpg)
- Миграции: Alembic
- Планировщик: asyncio task (scheduler_loop) + обязательные await sleep/timeout (чтобы не блокировать event loop)
- Логи: logging

13) Критические требования по надежности
- Никогда не блокировать event loop синхронным кодом (sleep, requests без async, тяжелые циклы).
- Любые операции сети/БД — с таймаутами.
- Планировщик должен работать в фоне и уступать управление (await asyncio.sleep()).
- У арендатора строгая изоляция данных (доступ только к своему объекту).

14) Минимальный MVP
MVP должен уметь:
- Админ: создать объект, добавить арендатора, настроить даты и реквизиты
- Tenant: принять согласие на ПДн, видеть начисления, отправить чек
- Админ: получить уведомление и подтвердить оплату
- Архивирование арендатора после выселения
- Автоопределение УК/РСО по локальной базе (можно начать с ручной базы для одного региона)
- Напоминания за 3 дня до срока

15) Расширения (после MVP)
- OCR улучшение + классификация чеков
- Интеграции с платежными провайдерами (для “сохранения карты” безопасно)
- Массовая загрузка домов/УК/РСО (региональные выгрузки)
- Аналитика и отчеты (долги, просрочки, загрузка объектов)
- Мультивладелец (несколько владельцев в одной платформе SaaS)
